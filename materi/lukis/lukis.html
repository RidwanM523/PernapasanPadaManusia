<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8">
  <link rel="icon" href="../../koleksi/Kemendikbud.png">
  <title>Pernapasan pada Manusia</title>
  <link rel="stylesheet" href="../navigasi.css">
  <link rel="stylesheet" href="../../border.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <script src="https://code.jquery.com/jquery-3.4.1.js"></script>
  <script src="https://kit.fontawesome.com/a076d05399.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    .container {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    canvas {
        border: 2px solid #000;
        margin-bottom: 10px;
    }

    .controls {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    #bucketFillButton.active {
        background-color: #ff0000;
        color: #ffffff;
    }
  </style>
</head>
<body>

<div class="header">
  <center>Drawing Box</center>
</div>
<div class="btn">
  <span class="fa fa-bars"></span>
</div>
<nav class="sidebar">
  <div class="text"><img src="../gambar/LOGO.png"></div>
  <ul>
    <li class="beranda"><a href="../../index.html">Beranda</a></li>
    <li>
      <a href="../pernapasan/1.html" class="migrasi">Materi Pembelajaran</a>
    </li>
    <li>
      <a href="#" class="kemagnetan">Sistem Pernapasan
        <span class="fa fa-caret-down second"></span>
      </a>
      <ul class="kemagnetan-tampil">
        <li><a href="../sistem/1/1.html">Alat Pernapasan</a></li>
        <li><a href="../sistem/2/1.html">Proses Pernapasan</a></li>
      </ul>
    </li>
    <li>
      <a href="../gangguan/1.html" class="produk">Gangguan Sistem Pernapasan</a>
    </li>
    <li><a href="#" style="color: #906741; background: #003c25;" class="migrasi">EVALUASI
        <span class="fa fa-caret-down second"></span>
      </a>
      <ul class="migrasi-tampil">
        <li><a style="  color: #906741;" href="../lukis/lukis.html">Drawing</a></li>
        <li><a href="../puzzle/puzzle.html">Puzzle</a></li>
        <li><a href="../Evaluasi/eva.html">Kuis</a></li>

      </ul>
    </li>
  </ul>
</nav>

<div class="content">
    <div class="container">
        <canvas id="drawingCanvas" style="margin-top: 25px;" width="800" height="500"></canvas>
        <div class="controls">
            <label for="colorPicker">Color:</label>
            <input type="color" id="colorPicker" value="#000000">
            <label for="sizePicker">Size:</label>
            <input type="range" id="sizePicker" min="1" max="10" value="5">
            <button id="clearButton">Clear</button>
            <button id="bucketFillButton">Bucket Fill</button>
            <button id="undoButton">Undo</button>
            <button id="redoButton">Redo</button>
        </div>
    </div>
  
  <br>
</div>

<div class="footer">
  <div class="navigasibawah">
    <center>
      <a href="../gangguan/1.html"><button>Sebelumnya</button></a>
      <a href="lukis.html"><button class="btn1">1</button></a>
      <a href="../puzzle/puzzle.html"><button>Selanjutnya</button></a>
    </center>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const canvas = document.getElementById('drawingCanvas');
    const ctx = canvas.getContext('2d');
    const colorPicker = document.getElementById('colorPicker');
    const sizePicker = document.getElementById('sizePicker');
    const clearButton = document.getElementById('clearButton');
    const bucketFillButton = document.getElementById('bucketFillButton');
    const undoButton = document.getElementById('undoButton');
    const redoButton = document.getElementById('redoButton');

    let drawing = false;
    let filling = false;
    let undoStack = [];
    let redoStack = [];

    function saveState() {
        undoStack.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
        redoStack = [];
        updateButtonStates();
    }

    function undo() {
        if (undoStack.length > 0) {
            redoStack.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
            const previousState = undoStack.pop();
            ctx.putImageData(previousState, 0, 0);
        }
        updateButtonStates();
    }

    function redo() {
        if (redoStack.length > 0) {
            undoStack.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
            const nextState = redoStack.pop();
            ctx.putImageData(nextState, 0, 0);
        }
        updateButtonStates();
    }

    function updateButtonStates() {
        undoButton.disabled = undoStack.length === 0;
        redoButton.disabled = redoStack.length === 0;
    }

    canvas.addEventListener('mousedown', (e) => {
        saveState();
        if (filling) {
            bucketFill(e);
        } else {
            startDrawing(e);
        }
    });
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mousemove', draw);
    clearButton.addEventListener('click', () => {
        saveState();
        clearCanvas();
    });
    bucketFillButton.addEventListener('click', () => {
        filling = !filling;
        bucketFillButton.classList.toggle('active', filling);
    });
    undoButton.addEventListener('click', undo);
    redoButton.addEventListener('click', redo);

    function startDrawing(e) {
        drawing = true;
        draw(e);
    }

    function stopDrawing() {
        drawing = false;
        ctx.beginPath();
    }

    function draw(e) {
        if (!drawing) return;

        ctx.lineWidth = sizePicker.value;
        ctx.lineCap = 'round';
        ctx.strokeStyle = colorPicker.value;

        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        ctx.lineTo(x, y);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(x, y);
    }

    function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function bucketFill(e) {
        const rect = canvas.getBoundingClientRect();
        const x = Math.round(e.clientX - rect.left);
        const y = Math.round(e.clientY - rect.top);

        const canvasWidth = canvas.width;
        const canvasHeight = canvas.height;
        const imageData = ctx.getImageData(0, 0, canvasWidth, canvasHeight);
        const clickedColor = getColorAtPixel(imageData, x, y);
        const fillColor = hexToRgba(colorPicker.value);

        if (colorsMatch(clickedColor, fillColor)) return;

        floodFill(imageData, x, y, clickedColor, fillColor);
        ctx.putImageData(imageData, 0, 0);
    }

    function getColorAtPixel(imageData, x, y) {
        const index = (y * imageData.width + x) * 4;
        const data = imageData.data;
        return {
            r: data[index],
            g: data[index + 1],
            b: data[index + 2],
            a: data[index + 3]
        };
    }

    function hexToRgba(hex) {
        let bigint = parseInt(hex.slice(1), 16);
        let r = (bigint >> 16) & 255;
        let g = (bigint >> 8) & 255;
        let b = bigint & 255;
        return { r, g, b, a: 255 };
    }

    function colorsMatch(a, b) {
        return a.r === b.r && a.g === b.g && a.b === b.b && a.a === b.a;
    }

    function floodFill(imageData, x, y, targetColor, fillColor) {
        const stack = [{ x, y }];
        const width = imageData.width;
        const height = imageData.height;
        const data = imageData.data;

        while (stack.length) {
            const { x, y } = stack.pop();
            const currentColor = getColorAtPixel(imageData, x, y);

            if (!colorsMatch(currentColor, targetColor)) continue;

            let currentX = x;
            let currentY = y;
            let pixelPos = (currentY * width + currentX) * 4;

            while (currentY >= 0 && colorsMatch(getColorAtPixel(imageData, currentX, currentY), targetColor)) {
                currentY--;
            }
            currentY++;

            let reachLeft = false;
            let reachRight = false;

            while (currentY < height && colorsMatch(getColorAtPixel(imageData, currentX, currentY), targetColor)) {
                setColorAtPixel(data, pixelPos, fillColor);

                if (currentX > 0) {
                    if (colorsMatch(getColorAtPixel(imageData, currentX - 1, currentY), targetColor)) {
                        if (!reachLeft) {
                            stack.push({ x: currentX - 1, y: currentY });
                            reachLeft = true;
                        }
                    } else if (reachLeft) {
                        reachLeft = false;
                    }
                }

                if (currentX < width - 1) {
                    if (colorsMatch(getColorAtPixel(imageData, currentX + 1, currentY), targetColor)) {
                        if (!reachRight) {
                            stack.push({ x: currentX + 1, y: currentY });
                            reachRight = true;
                        }
                    } else if (reachRight) {
                        reachRight = false;
                    }
                }

                currentY++;
                pixelPos = (currentY * width + currentX) * 4;
            }
        }
    }

    function setColorAtPixel(data, index, color) {
        data[index] = color.r;
        data[index + 1] = color.g;
        data[index + 2] = color.b;
        data[index + 3] = color.a;
    }
});
</script>

<script src="../navigasi.js"></script>
</body>
</html>
